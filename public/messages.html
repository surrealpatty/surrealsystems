<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Messages - CodeCrowds</title>
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="messages.css" />
</head>
<body>

<main class="container" role="main" aria-labelledby="messages-title">
  <h1 id="messages-title">Your Messages</h1>

  <nav class="tabbar" role="navigation" aria-label="Messages view">
    <button id="inboxBtn" class="tab active" aria-pressed="true">Received</button>
    <button id="sentBtn" class="tab" aria-pressed="false">Sent</button>
    <button id="goBackBtn" class="tab">Back to Profile</button>
  </nav>

  <section id="messages-list" class="messages-list" aria-live="polite">
    <p class="loading">Loading messages…</p>
  </section>
</main>

<script>
const API_URL = 'https://codecrowds.onrender.com/api';
const token = localStorage.getItem('token');
const userId = localStorage.getItem('userId');

if (!token || !userId) {
    window.location.href = 'index.html';
}

const messagesList = document.getElementById('messages-list');
const goBackBtn = document.getElementById('goBackBtn');
const inboxBtn = document.getElementById('inboxBtn');
const sentBtn = document.getElementById('sentBtn');

let lastView = 'inbox'; // remember which tab we were on (inbox | sent)

goBackBtn.addEventListener('click', () => {
    window.location.href = 'profile.html';
});
inboxBtn.addEventListener('click', () => { setActiveTab('inbox'); loadInbox(); });
sentBtn.addEventListener('click', () => { setActiveTab('sent'); loadSent(); });

function setActiveTab(tab) {
  lastView = tab;
  if (tab === 'inbox') {
    inboxBtn.classList.add('active');
    inboxBtn.setAttribute('aria-pressed', 'true');
    sentBtn.classList.remove('active');
    sentBtn.setAttribute('aria-pressed', 'false');
  } else {
    sentBtn.classList.add('active');
    sentBtn.setAttribute('aria-pressed', 'true');
    inboxBtn.classList.remove('active');
    inboxBtn.setAttribute('aria-pressed', 'false');
  }
}

// helper: extract messages array from server wrapper
function extractMessages(payload) {
  if (!payload) return [];
  if (Array.isArray(payload)) return payload;
  if (Array.isArray(payload.messages)) return payload.messages;
  if (payload.data && Array.isArray(payload.data.messages)) return payload.data.messages;
  return [];
}

function renderMessageCard(m, kind='inbox') {
  const article = document.createElement('article');
  article.className = 'card';
  article.setAttribute('tabindex', '0');

  if (kind === 'inbox') {
    const fromName = m.sender?.username || 'Unknown';
    article.innerHTML = `
      <h3>From: ${escapeHtml(fromName)}</h3>
      <p>${escapeHtml(m.content || '')}</p>
      <p class="timestamp">${new Date(m.createdAt).toLocaleString()}</p>
      <div class="card-actions">
        <button class="viewConversationBtn" data-userid="${m.sender?.id || m.senderId}" data-username="${escapeHtml(fromName)}">View Conversation</button>
      </div>
    `;
  } else {
    const toName = m.receiver?.username || 'Unknown';
    article.innerHTML = `
      <h3>To: ${escapeHtml(toName)}</h3>
      <p>${escapeHtml(m.content || '')}</p>
      <p class="timestamp">${new Date(m.createdAt).toLocaleString()}</p>
      <div class="card-actions">
        <button class="viewConversationBtn" data-userid="${m.receiver?.id || m.receiverId}" data-username="${escapeHtml(toName)}">View Conversation</button>
      </div>
    `;
  }

  return article;
}

// small helper to avoid injecting raw HTML from server
function escapeHtml(unsafe) {
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Load inbox (received messages)
async function loadInbox() {
    setActiveTab('inbox');
    inboxBtn.disabled = true;
    sentBtn.disabled = false;
    renderStatus('Loading received messages…');

    try {
        const res = await fetch(`${API_URL}/messages/inbox`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            const text = await res.text();
            console.error('Server returned error while fetching inbox:', res.status, res.statusText, text);
            renderError(`Failed to load messages (server returned ${res.status})`);
            return;
        }

        const data = await res.json();
        const messages = extractMessages(data);
        messagesList.innerHTML = '';

        if (!messages.length) {
            messagesList.innerHTML = '<p class="empty">No messages yet.</p>';
            return;
        }

        messages.forEach(m => {
            messagesList.appendChild(renderMessageCard(m, 'inbox'));
        });

        attachConversationButtons();

    } catch(err) {
        console.error(err);
        renderError('Failed to load messages');
    } finally {
        inboxBtn.disabled = false;
    }
}

// Load sent messages
async function loadSent() {
    setActiveTab('sent');
    sentBtn.disabled = true;
    inboxBtn.disabled = false;
    renderStatus('Loading sent messages…');

    try {
        const res = await fetch(`${API_URL}/messages/sent`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            const text = await res.text();
            console.error('Server returned error while fetching sent messages:', res.status, res.statusText, text);
            renderError(`Failed to load sent messages (server returned ${res.status})`);
            return;
        }

        const data = await res.json();
        const messages = extractMessages(data);
        messagesList.innerHTML = '';

        if (!messages.length) {
            messagesList.innerHTML = '<p class="empty">No sent messages yet.</p>';
            return;
        }

        messages.forEach(m => {
            messagesList.appendChild(renderMessageCard(m, 'sent'));
        });

        attachConversationButtons();

    } catch(err) {
        console.error(err);
        renderError('Failed to load sent messages');
    } finally {
        sentBtn.disabled = false;
    }
}

function attachConversationButtons() {
  document.querySelectorAll('.viewConversationBtn').forEach(btn => {
      btn.addEventListener('click', () => {
          const otherUserId = btn.dataset.userid;
          const otherUsername = btn.dataset.username;
          loadConversation(otherUserId, otherUsername);
      });
  });
}

async function loadConversation(otherUserId, otherUsername) {
    try {
        const res = await fetch(`${API_URL}/messages/thread/${otherUserId}`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            const text = await res.text();
            console.error('Server returned error while fetching conversation:', res.status, res.statusText, text);
            alert('Failed to load conversation (server error)');
            return;
        }

        const data = await res.json();
        const conversation = extractMessages(data);

        messagesList.innerHTML = `<h2>Conversation with ${escapeHtml(otherUsername)}</h2>`;

        // conversation is returned newest-first (DESC). Reverse if you want oldest-first:
        // conversation.reverse();

        conversation.forEach(m => {
            const article = document.createElement('article');
            article.className = 'card';
            article.setAttribute('tabindex', '0');
            const isMine = Number(m.senderId) === Number(userId);
            const who = isMine ? 'You' : (m.sender?.username || 'Unknown');
            article.innerHTML = `
                <h3>${escapeHtml(who)}</h3>
                <p>${escapeHtml(m.content || '')}</p>
                <p class="timestamp">${new Date(m.createdAt).toLocaleString()}</p>
            `;
            messagesList.appendChild(article);
        });

        // Back to last view (inbox or sent)
        const footer = document.createElement('div');
        footer.className = 'conversation-footer';
        const backBtn = document.createElement('button');
        backBtn.textContent = 'Back';
        backBtn.addEventListener('click', () => {
            if (lastView === 'sent') loadSent();
            else loadInbox();
        });
        footer.appendChild(backBtn);
        messagesList.appendChild(footer);

    } catch(err) {
        console.error(err);
        alert('Failed to load conversation.');
    }
}

// small helpers
function renderStatus(text) {
  messagesList.innerHTML = `<p class="loading">${escapeHtml(text)}</p>`;
}
function renderError(text) {
  messagesList.innerHTML = `<p class="error">${escapeHtml(text)}</p>`;
}

// Initialize - load inbox by default
window.addEventListener('load', () => {
  loadInbox();
});
</script>

</body>
</html>
