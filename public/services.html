<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Services - CodeCrowds</title>
<link rel="stylesheet" href="services.css" />

<!-- OPTIONAL CONFIG (uncomment & set these to lock exact backend) -->
<!--
<script>
  // Example: exact endpoint
  window.__API_BASE__ = '/api';
  window.__MESSAGE_ENDPOINT__ = '/api/v1/users/:userId/messages'; // tokens: :userId, :serviceId

  // Example: backend expects {recipientId, text}
  window.__MESSAGE_PAYLOAD_KEYS__ = {
    to: 'recipientId',
    text: 'text',
    service: 'serviceId'   // optional
  };
</script>
-->
</head>
<body>
<div class="container">
  <h1>All Services</h1>
  <p class="subtle">Browse everything users are offering across CodeCrowds.</p>

  <div class="controls" role="group" aria-label="Service search and sorting">
    <label class="sr-only" for="search">Search services</label>
    <input id="search" placeholder="Search services…" aria-describedby="searchHelp" />
    <span id="searchHelp" class="sr-only">Type to filter services by title, description, or username</span>

    <label class="sr-only" for="sort">Sort services</label>
    <select id="sort" title="Sort services">
      <option value="newest">Newest</option>
      <option value="priceLow">Price: Low → High</option>
      <option value="priceHigh">Price: High → Low</option>
    </select>
  </div>

  <div id="services-list" aria-live="polite">
    <p><span class="spinner"></span> Loading services…</p>
  </div>

  <!-- Compose Message Modal -->
  <div id="messageModal" role="dialog" aria-modal="true" aria-labelledby="messageTitle" aria-hidden="true">
    <div class="modal-content" role="document">
      <h2 id="messageTitle">Message <span id="messageRecipient"></span></h2>

      <div class="field-wrap">
        <textarea id="messageContent" placeholder="Write your message…" maxlength="2000" aria-label="Message body"></textarea>
      </div>

      <p id="sendError" class="error-inline" aria-live="polite" hidden></p>
      <details id="attemptDetails" hidden>
        <summary>Tried endpoints</summary>
        <ul id="attemptList" class="attempt-list"></ul>
      </details>

      <div class="modal-meta">
        <span id="charCount" aria-live="polite">0 / 2000</span>
      </div>
      <div class="modal-actions">
        <button type="button" id="sendMessageBtn">Send</button>
        <button type="button" id="cancelMessageBtn" class="button-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <div class="actions-row">
    <button type="button" id="goToProfileBtn" class="button-secondary" aria-label="Back to your profile">Back to Profile</button>
    <button type="button" id="refreshBtn" aria-label="Refresh services list">Refresh</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
// ---------- Config & helpers ----------
const API_BASE_INPUT = (window.__API_BASE__ ?? '/api');
const API_BASES = Array.from(new Set([API_BASE_INPUT, '/api', 'api', '/']))
  .map(b => String(b || '/').replace(/\/+$/,'') || '/');

const FIXED_ENDPOINT = window.__MESSAGE_ENDPOINT__ || null;
const CUSTOM_KEYS = window.__MESSAGE_PAYLOAD_KEYS__ || null;

function buildUrl(base, path) {
  const b = base === '/' ? '' : base;
  const p = String(path || '').replace(/^\/+/, '');
  return `${b}/${p}`;
}
function replaceTokens(url, {userId, serviceId}) {
  return url.replace(/:userId\b/g, encodeURIComponent(userId || ''))
            .replace(/:serviceId\b/g, encodeURIComponent(serviceId || ''));
}

// ---------- DOM ----------
const servicesList = document.getElementById('services-list');
const goToProfileBtn = document.getElementById('goToProfileBtn');
const refreshBtn = document.getElementById('refreshBtn');
const searchInput = document.getElementById('search');
const sortSelect = document.getElementById('sort');

const messageModal = document.getElementById('messageModal');
const messageRecipient = document.getElementById('messageRecipient');
const messageContent = document.getElementById('messageContent');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const cancelMessageBtn = document.getElementById('cancelMessageBtn');
const charCount = document.getElementById('charCount');
const sendError = document.getElementById('sendError');
const attemptDetails = document.getElementById('attemptDetails');
const attemptList = document.getElementById('attemptList');

let allServices = [];
let messageState = { toUserId: null, serviceId: null, username: '' };
let lastFocusedBeforeModal = null;

const MAX_LEN = 2000;

// ---------- Utils ----------
const esc = (s) => String(s ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const fmtPrice = (v) => {
  const n = Number(v);
  return Number.isFinite(n) ? n.toLocaleString(undefined, { maximumFractionDigits: 2 }) : esc(v);
};
function toast(msg) {
  const el = document.getElementById('toast');
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2200);
}
function getCsrf() {
  return (
    document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
    document.querySelector('meta[name="x-xsrf-token"]')?.getAttribute('content') ||
    null
  );
}
function showInlineError(msg) {
  sendError.textContent = msg;
  sendError.hidden = !msg;
}
function stringifyAny(value) {
  if (value == null) return '';
  if (typeof value === 'string') return value;
  try { return JSON.stringify(value); } catch { return String(value); }
}
function extractApiError(status, data, textFallback) {
  if (data && typeof data === 'object') {
    const keys = ['error', 'message', 'detail', 'reason'];
    for (const k of keys) if (data[k]) return `[${status}] ${typeof data[k]==='string'?data[k]:stringifyAny(data[k])}`;
    if (Array.isArray(data.errors) && data.errors.length) {
      const parts = data.errors.map(e => typeof e==='string' ? e :
        e?.message && e?.field ? `${e.field}: ${e.message}` :
        e?.message || stringifyAny(e));
      return `[${status}] ${parts.join('; ')}`;
    }
    if (data.details) return `[${status}] ${stringifyAny(data.details)}`;
    return `[${status}] ${stringifyAny(data)}`;
  }
  return `[${status}] ${textFallback || 'Request failed'}`;
}

// ---------- Render ----------
function render(services) {
  servicesList.innerHTML = '';
  if (!services.length) { servicesList.innerHTML = '<p>No services available.</p>'; return; }

  services.forEach((s) => {
    const div = document.createElement('div');
    div.className = 'service-card';
    div.innerHTML = `
      <h3>${esc(s.title)}</h3>
      <p>${esc(s.description)}</p>
      <p><strong>Price:</strong> $${fmtPrice(s.price)}</p>
      <p class="username">
        Posted by:
        ${s.user ? `<a href="profile.html?userId=${s.user.id}">${esc(s.user.username)}</a>` : 'Unknown'}
      </p>
      <div class="card-actions">
        <button
          type="button"
          class="message-btn"
          data-user-id="${s.user?.id ?? ''}"
          data-username="${esc(s.user?.username ?? '')}"
          data-service-id="${s.id ?? ''}"
          ${s.user ? '' : 'disabled'}
          aria-label="Message ${esc(s.user?.username ?? 'seller')}"
          title="${s.user ? 'Send a message to the seller' : 'No seller attached'}"
        >
          Message
        </button>
      </div>
    `;
    servicesList.appendChild(div);
  });
}

// ---------- Filters ----------
function applyFilters() {
  const q = searchInput.value.toLowerCase().trim();
  const filtered = allServices.filter((s) => {
    const hay = `${s.title||''} ${s.description||''} ${s.user?.username||''}`.toLowerCase();
    return hay.includes(q);
  });

  switch (sortSelect.value) {
    case 'priceLow': filtered.sort((a,b)=>Number(a.price)-Number(b.price)); break;
    case 'priceHigh': filtered.sort((a,b)=>Number(b.price)-Number(a.price)); break;
    default: filtered.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0));
  }
  render(filtered);
}

// ---------- Data ----------
async function loadServices() {
  servicesList.innerHTML = '<p><span class="spinner"></span> Loading services…</p>';
  let lastErr;
  for (const base of API_BASES) {
    try {
      const url = buildUrl(base, 'services');
      const res = await fetch(url, { credentials: 'include' });
      let data;
      try { data = await res.json(); } catch { data = []; }
      if (!res.ok) throw new Error((data && (data.error || data.message)) || `HTTP ${res.status}`);
      allServices = data.services || data || [];
      applyFilters();
      console.info('[services] loaded from', url);
      return;
    } catch (e) { lastErr = e; }
  }
  console.error('[services] load failed:', lastErr);
  servicesList.innerHTML = '<p class="error">Failed to load services</p>';
}

// ---------- A11y / Modal ----------
function updateCounterAndState() {
  const len = (messageContent.value || '').length;
  if (charCount) charCount.textContent = `${len} / ${MAX_LEN}`;
  const ok = len > 0 && len <= MAX_LEN && !!messageState.toUserId;
  sendMessageBtn.disabled = !ok;
}
function trapFocusIn(node, e) {
  if (e.key !== 'Tab') return;
  const focusables = node.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  const a = Array.from(focusables).filter(x => !x.disabled && x.offsetParent !== null);
  if (!a.length) return;
  const first = a[0], last = a[a.length - 1];
  if (e.shiftKey && document.activeElement === first) {
    e.preventDefault(); last.focus();
  } else if (!e.shiftKey && document.activeElement === last) {
    e.preventDefault(); first.focus();
  }
}
function showModal() {
  lastFocusedBeforeModal = document.activeElement;
  messageModal.style.display = 'flex';
  messageModal.setAttribute('aria-hidden', 'false');
  showInlineError('');
  attemptDetails.hidden = true; attemptList.innerHTML = '';
  updateCounterAndState();
  setTimeout(() => messageContent?.focus(), 0);
  window.addEventListener('keydown', onModalKey);
}
function hideModal() {
  messageModal.style.display = 'none';
  messageModal.setAttribute('aria-hidden', 'true');
  if (messageContent) messageContent.value = '';
  showInlineError('');
  attemptDetails.hidden = true; attemptList.innerHTML = '';
  updateCounterAndState();
  messageState = { toUserId: null, serviceId: null, username: '' };
  window.removeEventListener('keydown', onModalKey);
  if (lastFocusedBeforeModal && lastFocusedBeforeModal.focus) lastFocusedBeforeModal.focus();
}
function openMessageModal({ toUserId, serviceId, username }) {
  messageState = { toUserId, serviceId, username };
  messageRecipient.textContent = username || 'seller';
  showModal();
}
function onModalKey(e) {
  if (messageModal.style.display !== 'flex') return;
  if (e.key === 'Tab') trapFocusIn(messageModal, e);
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    if (!sendMessageBtn.disabled) sendMessage();
  }
}
function logAttempt(url, status) {
  attemptDetails.hidden = false;
  const li = document.createElement('li');
  li.textContent = `${url}  →  ${status}`;
  attemptList.appendChild(li);
}

// ---------- Endpoint & payload planning ----------
function plannedEndpoints() {
  const uid = encodeURIComponent(messageState.toUserId || '');
  const sid = encodeURIComponent(messageState.serviceId || '');

  // If user config provided, use only that
  if (FIXED_ENDPOINT) {
    return [replaceTokens(FIXED_ENDPOINT, {userId: uid, serviceId: sid})];
  }

  // Otherwise try a broad, sensible set
  const out = [];
  for (const b of API_BASES) {
    // Generic messages
    out.push(buildUrl(b, 'messages'));
    out.push(buildUrl(b, 'messages/send'));
    out.push(buildUrl(b, 'v1/messages'));
    out.push(buildUrl(b, 'v1/messages/send'));
    out.push(buildUrl(b, 'chat/messages'));
    out.push(buildUrl(b, 'direct-messages'));

    // User-scoped
    out.push(buildUrl(b, `users/${uid}/messages`));
    out.push(buildUrl(b, `users/${uid}/messages/send`));
    out.push(buildUrl(b, `v1/users/${uid}/messages`));

    // Conversation/threads starters
    out.push(buildUrl(b, 'conversations'));
    out.push(buildUrl(b, 'conversations/start'));
    out.push(buildUrl(b, `users/${uid}/conversations`));
    out.push(buildUrl(b, 'threads'));
    out.push(buildUrl(b, 'threads/start'));
  }
  // de-dupe
  return Array.from(new Set(out));
}

function payloadVariants(text) {
  if (CUSTOM_KEYS) {
    const toKey = CUSTOM_KEYS.to || 'toUserId';
    const textKey = CUSTOM_KEYS.text || 'body';
    const serviceKey = CUSTOM_KEYS.service || 'serviceId';
    const obj = {};
    obj[toKey] = messageState.toUserId;
    obj[textKey] = text;
    if (messageState.serviceId) obj[serviceKey] = messageState.serviceId;
    return [obj];
  }
  // Try common shapes
  return [
    { toUserId: messageState.toUserId, serviceId: messageState.serviceId || null, body: text },
    { recipientId: messageState.toUserId, serviceId: messageState.serviceId || null, text },
    { to: messageState.toUserId, serviceId: messageState.serviceId || null, content: text },
  ];
}

// ---------- Send (configurable & robust) ----------
async function sendMessage() {
  const text = (messageContent.value || '').trim();
  if (!messageState.toUserId) { showInlineError('Missing recipient.'); return; }
  if (!text) { showInlineError('Please write a message.'); messageContent.focus(); return; }
  showInlineError('');

  const csrf = getCsrf();
  const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
  if (csrf) { headers['X-CSRF-Token'] = csrf; headers['X-XSRF-TOKEN'] = csrf; }

  const endpoints = plannedEndpoints();
  const payloads = payloadVariants(text);

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 15000);

  try {
    sendMessageBtn.disabled = true;
    sendMessageBtn.textContent = 'Sending…';

    let lastErrMsg = 'Unknown error';

    for (const url of endpoints) {
      for (const body of payloads) {
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers,
            credentials: 'include',
            body: JSON.stringify(body),
            signal: controller.signal
          });

          logAttempt(url, res.status);

          if (res.status === 204) { hideModal(); toast('Message sent!'); return; }

          let data = null, textBody = '';
          try { data = await res.json(); }
          catch { textBody = await res.text().catch(() => ''); }

          if (res.ok) {
            hideModal(); toast('Message sent!');
            // if (data?.threadId) location.href = `/messages?thread=${encodeURIComponent(data.threadId)}`;
            return;
          }

          const msg = extractApiError(res.status, data, textBody);
          lastErrMsg = msg;

          if (res.status === 401 || res.status === 403) {
            showInlineError(msg || 'Not authorized. Check sign-in/CSRF.');
            return;
          }
          // try next variant/endpoint
        } catch (netErr) {
          logAttempt(url, netErr?.name === 'AbortError' ? 'timeout' : (netErr?.message || 'network error'));
          lastErrMsg = netErr?.message || stringifyAny(netErr);
          // continue
        }
      }
    }

    showInlineError(`Failed to send: ${lastErrMsg}.
Hint: set window.__MESSAGE_ENDPOINT__ to your exact route (e.g. "/api/v1/users/:userId/messages")
and optionally window.__MESSAGE_PAYLOAD_KEYS__ = { to:"recipientId", text:"text", service:"serviceId" }`);
  } finally {
    clearTimeout(timeout);
    sendMessageBtn.disabled = false;
    sendMessageBtn.textContent = 'Send';
    updateCounterAndState();
  }
}

// ---------- Events ----------
goToProfileBtn.addEventListener('click', () => { window.location.href = 'profile.html'; });
refreshBtn.addEventListener('click', loadServices);
searchInput.addEventListener('input', applyFilters);
sortSelect.addEventListener('change', applyFilters);

servicesList.addEventListener('click', (e) => {
  const btn = e.target.closest('.message-btn');
  if (!btn) return;
  const toUserId = btn.getAttribute('data-user-id');
  const username = btn.getAttribute('data-username') || 'seller';
  const serviceId = btn.getAttribute('data-service-id');
  if (!toUserId) { toast('This service has no associated user.'); return; }
  messageState = { toUserId, serviceId, username };
  messageRecipient.textContent = username || 'seller';
  showModal();
});

cancelMessageBtn.addEventListener('click', hideModal);
sendMessageBtn.addEventListener('click', sendMessage);

// Close modal on ESC or click backdrop
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && messageModal.style.display === 'flex') hideModal();
});
messageModal.addEventListener('click', (e) => {
  if (e.target === messageModal) hideModal();
});

// Counter while typing
messageContent.addEventListener('input', updateCounterAndState);

window.addEventListener('load', () => {
  updateCounterAndState();
  loadServices();
});
</script>
</body>
</html>
