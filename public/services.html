<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Services - CodeCrowds</title>
<link rel="stylesheet" href="style.css">
<style>
.container {
    max-width: 800px;
    width: 100%;
    padding: 2.5rem 2rem;
    background: rgba(255,255,255,0.95);
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    margin: 2rem auto;
}
#services-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.service-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: transform 0.2s;
}
.service-card:hover { transform: translateY(-5px); }
.service-card h3 { margin: 0; color: #007bff; }
.service-card p { margin: 0; color: #555; }

.contact-section {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}
.contact-section textarea {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 0.5rem;
}
.contact-section button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
.contact-section button:hover {
    background: #0056b3;
}

.message { font-weight: 600; margin-top: 0.5rem; }
.message.success { color: #28a745; }
.message.error { color: #ff4d4f; }

form input, form textarea, form button {
    width: 100%;
    margin-bottom: 1rem;
    padding: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
}
form button {
    background-color: #007bff;
    color: #fff;
}
form button:hover { background-color: #0056b3; }

#backProfileBtn {
    padding: 12px 25px;
    background-color: #00aaff;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 0.5rem;
}
#backProfileBtn:hover { background-color: #008ecc; }
</style>
</head>
<body>
<div class="container">
    <h1>Available Services</h1>
    <div id="services-list"></div>

    <h2>Add a New Service</h2>
    <form id="serviceForm">
        <input type="text" id="service-title" placeholder="Service Title" required>
        <textarea id="service-description" placeholder="Service Description" required></textarea>
        <input type="number" id="service-price" placeholder="Price" min="0" required>
        <button type="submit">Add Service</button>
    </form>
    <button id="backProfileBtn">Back to Profile</button>
    <p id="service-message" class="message"></p>
</div>

<script>
const API_URL = 'https://codecrowds.onrender.com';
const token = localStorage.getItem('token');
const userId = localStorage.getItem('userId');

const servicesList = document.getElementById('services-list');
const serviceForm = document.getElementById('serviceForm');
const serviceMessage = document.getElementById('service-message');

if (!userId || !token) {
    alert('You must be logged in to view this page.');
    window.location.href = 'index.html';
}

// Load all services
async function loadServices() {
    try {
        const res = await fetch(`${API_URL}/services`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const services = await res.json();
        servicesList.innerHTML = '';

        services.forEach(function(s) {
            const div = document.createElement('div');
            div.className = 'service-card';
            div.innerHTML = `
                <h3>${s.title}</h3>
                <p>${s.description}</p>
                <p><strong>Price:</strong> $${s.price}</p>
                <p><strong>By:</strong> ${s.username || s.userId}</p>
                <button class="contact-toggle">Contact ${s.username || 'Provider'}</button>
                <div class="contact-section">
                    <textarea placeholder="Write your message..."></textarea>
                    <button class="send-btn">Send Message</button>
                    <p class="message"></p>
                </div>
            `;

            const toggleBtn = div.querySelector('.contact-toggle');
            const contactSection = div.querySelector('.contact-section');
            const sendBtn = div.querySelector('.send-btn');
            const textarea = div.querySelector('textarea');
            const messageBox = div.querySelector('.message');

            // Toggle dropdown
            toggleBtn.addEventListener('click', () => {
                contactSection.style.display = contactSection.style.display === 'block' ? 'none' : 'block';
            });

            // Send message
            sendBtn.addEventListener('click', async () => {
                const content = textarea.value.trim();
                if (!content) return alert("Message cannot be empty.");

                try {
                    const res = await fetch(`${API_URL}/messages`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            senderId: userId,
                            receiverId: s.userId,
                            content
                        })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        messageBox.textContent = "Message sent!";
                        messageBox.className = "message success";
                        textarea.value = '';
                    } else {
                        messageBox.textContent = data.error || "Failed to send message.";
                        messageBox.className = "message error";
                    }
                } catch (err) {
                    console.error(err);
                    messageBox.textContent = "Network error: " + err.message;
                    messageBox.className = "message error";
                }
            });

            servicesList.appendChild(div);
        });
    } catch (err) {
        servicesList.innerHTML = '<p class="error">Failed to load services</p>';
        console.error(err);
    }
}

// Add a new service
serviceForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const title = document.getElementById('service-title').value.trim();
    const description = document.getElementById('service-description').value.trim();
    const price = parseFloat(document.getElementById('service-price').value);

    if (!title || !description || isNaN(price)) return alert('All fields are required.');

    try {
        const res = await fetch(`${API_URL}/services`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, description, price, userId })
        });
        const data = await res.json();
        if (res.ok) {
            serviceMessage.textContent = 'Service added successfully!';
            serviceMessage.className = 'message success';
            serviceForm.reset();
            loadServices();
        } else {
            serviceMessage.textContent = data.error || 'Failed to add service';
            serviceMessage.className = 'message error';
        }
    } catch (err) {
        serviceMessage.textContent = 'Network error: ' + err.message;
        serviceMessage.className = 'message error';
        console.error(err);
    }
});

// Back to profile
document.getElementById('backProfileBtn').addEventListener('click', function() {
    window.location.href = 'profile.html';
});

window.onload = loadServices;
</script>
</body>
</html>
