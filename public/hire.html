<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hire - CodeCrowds</title>
<link rel="stylesheet" href="style.css">
<style>
body, html {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #4e54c8, #00aaff);
    min-height: 100%;
    color: #333;
}
.container {
    max-width: 600px;
    width: 90%;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    margin: 50px auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
h1 { color: #4e54c8; text-align: center; }
form input, form textarea, form button {
    width: 100%;
    padding: 12px;
    margin-bottom: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
    box-sizing: border-box;
}
form button {
    background-color: #4e54c8;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: 0.3s;
}
form button:hover { background-color: #3b40a1; }
.message {
    font-weight: 600;
    color: #28a745;
    text-align: center;
}
.error { color: #ff4d4f; }
</style>
</head>
<body>
<div class="container">
    <h1 id="hireHeading">Contact Service Provider</h1>
    <form id="messageForm">
        <textarea id="messageContent" placeholder="Write your message..." required></textarea>
        <button type="submit">Send Message</button>
    </form>
    <p id="responseMessage" class="message"></p>
</div>

<script>
const API_URL = 'https://codecrowds.onrender.com';
const token = localStorage.getItem('token');
const userId = localStorage.getItem('userId');
const hireHeading = document.getElementById('hireHeading');
const messageForm = document.getElementById('messageForm');
const messageContent = document.getElementById('messageContent');
const responseMessage = document.getElementById('responseMessage');

// Get posterId from URL query params
const urlParams = new URLSearchParams(window.location.search);
const posterId = urlParams.get('posterId');

// Redirect if not logged in or posterId missing
if (!token || !userId || !posterId) {
    alert('Invalid access.');
    window.location.href = 'services.html';
}

// Load poster's username and update heading
async function loadPosterName() {
    try {
        const res = await fetch(`${API_URL}/users/${posterId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok) {
            hireHeading.textContent = `Contact ${data.username}`;
            messageContent.value = `Hi ${data.username}, I'm interested in your service.`;
        } else {
            hireHeading.textContent = 'Contact Service Provider';
        }
    } catch (err) {
        console.error(err);
        hireHeading.textContent = 'Contact Service Provider';
    }
}

loadPosterName();

// Handle message submission
messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = messageContent.value.trim();
    if (!message) return;

    try {
        const res = await fetch(`${API_URL}/messages`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                senderId: userId,
                receiverId: posterId,
                content: message
            })
        });
        const data = await res.json();
        if (res.ok) {
            responseMessage.textContent = 'Message sent successfully!';
            responseMessage.className = 'message';
            messageForm.reset();
        } else {
            responseMessage.textContent = data.error || 'Failed to send message.';
            responseMessage.className = 'message error';
        }
    } catch (err) {
        console.error(err);
        responseMessage.textContent = 'Network error: ' + err.message;
        responseMessage.className = 'message error';
    }
});
</script>
</body>
</html>
