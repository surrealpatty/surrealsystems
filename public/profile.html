<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - CodeCrowds</title>
<link rel="stylesheet" href="style.css">
<style>
body, html {
    height: 100%;
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #6cc1ff, #3a8dff);
    display: flex;
    justify-content: center;
    padding: 2rem 0;
}

.container {
    max-width: 800px;
    width: 100%;
    padding: 2.5rem 2rem;
    background: rgba(255,255,255,0.95);
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
}

h1, h2 {
    text-align: center;
    color: #007bff;
    margin: 0;
}

form {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

input, textarea, button {
    width: 100%;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
    box-sizing: border-box;
}

button {
    background: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
}

button:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

/* Services Grid */
#services-list {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.service-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.service-card h3 {
    margin: 0;
    color: #007bff;
}

.service-card p {
    margin: 0;
    color: #555;
}

/* Card buttons */
.service-card button {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
}

.service-card .edit-btn {
    background: #28a745;
    color: #fff;
}

.service-card .edit-btn:hover {
    background: #1e7e34;
}

.service-card .delete-btn {
    background: #ff4d4f;
    color: #fff;
}

.service-card .delete-btn:hover {
    background: #c30000;
}

/* Logout */
.logout-btn {
    margin-top: 1rem;
    background: #ff4d4f;
}

.logout-btn:hover {
    background: #c30000;
}

.message {
    font-weight: bold;
}

.message.success { color: green; }
.message.error { color: red; }
</style>
</head>
<body>
<div class="container">
    <h1 id="usernameDisplay">User</h1>

    <!-- Profile Form -->
    <form id="profileForm">
        <input type="text" id="username" placeholder="Username">
        <textarea id="description" rows="3" placeholder="Describe your work"></textarea>
        <button type="submit">Update Profile</button>
    </form>

    <!-- Services Section -->
    <h2>Your Services</h2>
    <div id="services-list"></div>

    <!-- Add New Service Form -->
    <h2>Add a New Service</h2>
    <form id="serviceForm">
        <input type="text" id="service-title" placeholder="Service Title" required>
        <textarea id="service-description" placeholder="Service Description" required></textarea>
        <input type="number" id="service-price" placeholder="Price" required>
        <button type="submit">Add Service</button>
    </form>
    <p id="service-message" class="message"></p>

    <button id="logoutBtn" class="logout-btn">Log Out</button>
</div>

<script>
const API_URL = 'https://codecrowds.onrender.com';
const usernameDisplay = document.getElementById('usernameDisplay');
const usernameInput = document.getElementById('username');
const descriptionInput = document.getElementById('description');
const profileForm = document.getElementById('profileForm');
const servicesList = document.getElementById('services-list');
const serviceForm = document.getElementById('serviceForm');
const serviceMessage = document.getElementById('service-message');

const userId = localStorage.getItem('userId');
const token = localStorage.getItem('token');

if (!userId || !token) {
    alert('You must be logged in to view this page.');
    window.location.href = 'login.html';
}

// Load profile info
usernameDisplay.textContent = localStorage.getItem('username') || 'User';
usernameInput.value = localStorage.getItem('username') || '';
descriptionInput.value = localStorage.getItem('description') || '';

// Load user services
async function loadUserServices() {
    try {
        const res = await fetch(`${API_URL}/services`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const services = await res.json();
        servicesList.innerHTML = '';
        services
            .filter(s => s.userId == userId)
            .forEach(s => {
                const div = document.createElement('div');
                div.className = 'service-card';
                div.innerHTML = `
                    <h3>${s.title}</h3>
                    <p>${s.description}</p>
                    <p><strong>Price:</strong> $${s.price}</p>
                    <button class="edit-btn">Edit</button>
                    <button class="delete-btn">Delete</button>
                `;
                div.querySelector('.edit-btn').addEventListener('click', () => editService(s));
                div.querySelector('.delete-btn').addEventListener('click', () => deleteService(s.id));
                servicesList.appendChild(div);
            });
    } catch (err) {
        servicesList.innerHTML = '<p class="error">Failed to load services</p>';
        console.error(err);
    }
}
loadUserServices();

// Update profile
profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = usernameInput.value.trim();
    const description = descriptionInput.value.trim();
    if (!username) return alert('Username required');

    try {
        const res = await fetch(`${API_URL}/users/${userId}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ username, description })
        });
        const data = await res.json();
        if (res.ok) {
            alert('Profile updated successfully!');
            localStorage.setItem('username', data.user.username);
            localStorage.setItem('description', data.user.description || '');
            usernameDisplay.textContent = data.user.username;
        } else {
            alert(data.error || 'Failed to update profile');
        }
    } catch (err) {
        alert('Network error: ' + err.message);
        console.error(err);
    }
});

// Add new service
serviceForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('service-title').value.trim();
    const description = document.getElementById('service-description').value.trim();
    const price = parseFloat(document.getElementById('service-price').value);
    if (!title || !description || !price) return;

    try {
        const res = await fetch(`${API_URL}/services`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, description, price, userId })
        });
        const data = await res.json();
        if (res.ok) {
            serviceMessage.textContent = 'Service added successfully!';
            serviceMessage.className = 'message success';
            serviceForm.reset();
            loadUserServices();
        } else {
            serviceMessage.textContent = data.error || 'Failed to add service';
            serviceMessage.className = 'message error';
        }
    } catch (err) {
        serviceMessage.textContent = 'Network error: ' + err.message;
        serviceMessage.className = 'message error';
        console.error(err);
    }
});

// Edit service
function editService(service) {
    const newTitle = prompt('Edit title', service.title);
    const newDesc = prompt('Edit description', service.description);
    const newPrice = prompt('Edit price', service.price);
    if (!newTitle || !newDesc || !newPrice) return;

    fetch(`${API_URL}/services/${service.id}`, {
        method: 'PUT',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ title: newTitle, description: newDesc, price: parseFloat(newPrice) })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) alert(data.error);
        loadUserServices();
    })
    .catch(err => alert('Network error: ' + err.message));
}

// Delete service
function deleteService(serviceId) {
    if (!confirm('Are you sure you want to delete this service?')) return;
    fetch(`${API_URL}/services/${serviceId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) alert(data.error);
        loadUserServices();
    })
    .catch(err => alert('Network error: ' + err.message));
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'login.html';
});
</script>
</body>
</html>
