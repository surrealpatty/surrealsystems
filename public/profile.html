<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - CodeCrowds</title>
<link rel="stylesheet" href="profile.css" />
</head>
<body>
  <main class="container">
    <header>
      <h1 id="profile-username"><span class="spinner"></span> Loading username...</h1>
      <p id="profile-description"><span class="spinner"></span> Loading description...</p>
      <div id="descControls" class="hidden">
        <button type="button" id="editDescBtn">Edit Description</button>
      </div>
    </header>

    <section>
      <h2>User's Services</h2>
      <p class="section-subtle">These also appear on the Services page.</p>
      <div id="services-list"><p><span class="spinner"></span> Loading services...</p></div>

      <!-- Load more row -->
      <div class="row row-center row-gap-8 justify-center">
        <button type="button" id="loadMoreServicesBtn" class="hidden">Load more</button>
      </div>

      <div id="newServiceSection" class="new-service">
        <input type="text" id="newServiceTitle" placeholder="Service Title" />
        <textarea id="newServiceDesc" placeholder="Service Description"></textarea>
        <input type="number" id="newServicePrice" placeholder="Price in USD" />
        <button type="button" id="createServiceBtn">Create Service</button>
      </div>
    </section>

    <section>
      <h2>Ratings & Reviews</h2>

      <!-- Summary -->
      <div id="ratings-summary" class="card">
        <p>
          <strong><span id="avg-stars">0.0</span> / 5.0</strong>
          •
          <span id="ratings-count">0</span> ratings
        </p>
      </div>

      <!-- Rate (only when viewing someone else AND current user is PAID) -->
      <div id="rate-form" class="card hidden" aria-labelledby="rateFormTitle">
        <h3 id="rateFormTitle">Leave a rating</h3>

        <div class="row row-center row-gap-8">
          <label for="rateStars">Stars</label>
          <select id="rateStars" title="Select stars">
            <option value="5">5</option><option value="4">4</option>
            <option value="3">3</option><option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>

        <textarea id="rateComment" class="w-full" placeholder="Say something helpful (optional)" rows="3"></textarea>
        <button type="button" id="submitRatingBtn">Submit Rating</button>
        <p id="rateMsg" class="muted"></p>

        <!-- Shown if the user is free -->
        <div id="rateUpgradeHint" class="hidden muted">
          Rating is a paid feature.
          <button type="button" id="upgradeInlineBtn" class="upgrade-btn">Upgrade to Paid</button>
        </div>
      </div>

      <!-- List -->
      <div id="ratings-list" class="review-list">
        <p><span class="spinner"></span> Loading ratings...</p>
      </div>
    </section>

    <div class="row row-center row-gap-8 justify-center">
      <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
      <!-- Show this on your own profile if you're free -->
      <button type="button" id="upgradeBtn" class="upgrade-btn hidden">Upgrade to Paid</button>
    </div>
  </main>

  <!-- Floating shortcuts (only on your own profile) -->
  <button type="button" class="floating-btn hidden" id="goToServicesBtn">Services</button>
  <button type="button" class="floating-btn hidden" id="goToMessagesBtn">Messages</button>
  <button type="button" class="floating-btn hidden" id="addNewServiceBtn">+ Service</button>
  <button type="button" class="floating-btn hidden" id="editDescBtnFloat">Edit Bio</button>

  <!-- Back to my profile (visible only when viewing someone else) -->
  <button type="button" class="floating-btn hidden" id="backToMyProfileBtn">← My Profile</button>

  <nav class="mobile-button-row hidden" id="mobileRow" aria-label="Mobile actions">
    <button type="button" id="mobileServicesBtn">Services</button>
    <button type="button" id="mobileMessagesBtn">Messages</button>
    <button type="button" id="mobileAddServiceBtn">+ Service</button>
    <button type="button" id="mobileBackBtn" class="hidden">My Profile</button>
  </nav>

<script>
const API_URL = '/api';
const token = localStorage.getItem('token');
const loggedInUserId = localStorage.getItem('userId')?.toString();

// Use userId from URL (fallback to own)
const params = new URLSearchParams(window.location.search);
const qsUserId = params.get('userId');
const profileUserId = (qsUserId || loggedInUserId)?.toString();

// Kill old key that used to override navigation
localStorage.removeItem('profileUserId');

// Require login (remove this block if you allow public view)
if (!token || !loggedInUserId) {
  alert('You must log in first');
  window.location.href = 'index.html';
}

// ------- DOM
const profileUsername = document.getElementById('profile-username');
const profileDescription = document.getElementById('profile-description');
const descControls = document.getElementById('descControls');
const editDescBtn = document.getElementById('editDescBtn');

const servicesList = document.getElementById('services-list');
const newServiceSection = document.getElementById('newServiceSection');
const newServiceTitle = document.getElementById('newServiceTitle');
const newServiceDesc = document.getElementById('newServiceDesc');
const newServicePrice = document.getElementById('newServicePrice');
const createServiceBtn = document.getElementById('createServiceBtn');

const goToServicesBtn = document.getElementById('goToServicesBtn');
const goToMessagesBtn = document.getElementById('goToMessagesBtn');
const addNewServiceBtn = document.getElementById('addNewServiceBtn');
const editDescBtnFloat = document.getElementById('editDescBtnFloat');
const mobileServicesBtn = document.getElementById('mobileServicesBtn');
const mobileMessagesBtn = document.getElementById('mobileMessagesBtn');
const mobileAddServiceBtn = document.getElementById('mobileAddServiceBtn');
const mobileRow = document.getElementById('mobileRow');
const mobileBackBtn = document.getElementById('mobileBackBtn');

const ratingsList = document.getElementById('ratings-list');
const avgStarsEl = document.getElementById('avg-stars');
const ratingsCountEl = document.getElementById('ratings-count');
const rateForm = document.getElementById('rate-form');
const rateStars = document.getElementById('rateStars');
const rateComment = document.getElementById('rateComment');
const submitRatingBtn = document.getElementById('submitRatingBtn');
const rateMsg = document.getElementById('rateMsg');
const rateUpgradeHint = document.getElementById('rateUpgradeHint');
const upgradeInlineBtn = document.getElementById('upgradeInlineBtn');

const logoutBtn = document.getElementById('logoutBtn');
const upgradeBtn = document.getElementById('upgradeBtn');

const backToMyProfileBtn = document.getElementById('backToMyProfileBtn');
const loadMoreBtn = document.getElementById('loadMoreServicesBtn');

let currentUserTier = 'free'; // will be set by fetch of /users/me

// --- Services pagination state
let svcPage = 1;
let svcHasMore = false;
let svcLoading = false;

// ------- Helpers
function showOwnerUI(isOwner) {
  [goToServicesBtn, goToMessagesBtn, addNewServiceBtn, editDescBtnFloat, mobileRow, descControls, newServiceSection]
    .forEach(el => el.classList.toggle('hidden', !isOwner));
  // Show "Back to My Profile" only when viewing someone else
  backToMyProfileBtn.classList.toggle('hidden', isOwner);
  mobileBackBtn.classList.toggle('hidden', isOwner);
}

function esc(s) { return String(s ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function starText(n) {
  const r = Math.round(n);
  return '★'.repeat(r) + '☆'.repeat(5 - r);
}

async function fetchMe() {
  const res = await fetch(`${API_URL}/users/me`, { headers: { Authorization: `Bearer ${token}` } });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  currentUserTier = (data.user?.tier) || 'free';
  return data.user;
}

// ------- Profile
async function loadProfile() {
  try {
    const viewingSelf = profileUserId === loggedInUserId;

    // Always fetch current user to know tier
    await fetchMe();

    const endpoint = viewingSelf ? `${API_URL}/users/me` : `${API_URL}/users/${profileUserId}`;
    const res = await fetch(endpoint, { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

    const u = data.user || data;
    profileUsername.textContent = u.username || 'Unknown User';
    profileDescription.textContent = u.description || 'No description yet.';

    showOwnerUI(viewingSelf);

    // Rate form visibility: only if not viewing self AND current user is PAID
    const canRate = (!viewingSelf && currentUserTier === 'paid');
    rateForm.classList.toggle('hidden', !canRate);
    rateUpgradeHint.classList.toggle('hidden', canRate); // show hint when cannot rate

    // Show "Upgrade to Paid" button if it's your own profile and you're free
    if (viewingSelf && currentUserTier === 'free') {
      upgradeBtn.classList.remove('hidden');
    } else {
      upgradeBtn.classList.add('hidden');
    }
  } catch (err) {
    console.error('Error loading profile:', err);
    profileUsername.textContent = 'Unknown User';
    profileDescription.textContent = 'Failed to load profile';
    showOwnerUI(false);
  }
}

// ------- Edit / Save Description (owner only)
let editingDesc = false;
function toggleDescEdit(force) {
  editingDesc = typeof force === 'boolean' ? force : !editingDesc;
  profileDescription.contentEditable = editingDesc;
  editDescBtn.textContent = editingDesc ? 'Save Description' : 'Edit Description';
  if (editingDesc) profileDescription.focus(); else profileDescription.blur();
}
async function saveDescription() {
  const newDesc = profileDescription.textContent.trim();
  try {
    const res = await fetch(`${API_URL}/users/me/description`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ description: newDesc })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || 'Failed to save description');
    profileDescription.textContent = json.user?.description || newDesc;
  } catch (err) {
    alert('Failed to save description'); console.error(err);
  } finally {
    toggleDescEdit(false);
  }
}
editDescBtn.addEventListener('click', () => !editingDesc ? toggleDescEdit(true) : saveDescription());
editDescBtnFloat.addEventListener('click', () => !editingDesc ? toggleDescEdit(true) : saveDescription());

// ------- Services (PAGINATED)
function serviceCardHTML(s, isOwner) {
  return `
    <div class="card">
      <h3>${esc(s.title)}</h3>
      <p>${esc(s.description)}</p>
      <p><strong>Price:</strong> $${Number(s.price).toLocaleString(undefined,{maximumFractionDigits:2})}</p>
      <div class="service-buttons ${isOwner ? '' : 'hidden'}">
        <button class="edit-service-btn" data-id="${s.id}">Edit</button>
        <button class="delete-service-btn" data-id="${s.id}">Delete</button>
      </div>
    </div>
  `;
}

async function loadServices({ reset = false } = {}) {
  if (svcLoading) return;
  svcLoading = true;

  try {
    if (reset) {
      svcPage = 1;
      servicesList.innerHTML = '<p><span class="spinner"></span> Loading services...</p>';
      loadMoreBtn.classList.add('hidden');
    } else {
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = 'Loading...';
    }

    const url = new URL(`${API_URL}/services`, window.location.origin);
    url.searchParams.set('userId', profileUserId);
    url.searchParams.set('limit', '12');
    url.searchParams.set('page', String(svcPage));

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

    const list = data.services || [];
    svcHasMore = !!data.hasMore;

    if (reset) servicesList.innerHTML = '';

    if (!list.length && svcPage === 1) {
      servicesList.innerHTML = '<div class="card"><h3>No Services Yet</h3><p class="muted">Nothing posted yet.</p></div>';
      loadMoreBtn.classList.add('hidden');
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach((s) => {
      const isOwner = loggedInUserId === (s.user?.id?.toString() || s.userId?.toString() || '');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = serviceCardHTML(s, isOwner);
      frag.appendChild(wrapper.firstElementChild);
    });
    servicesList.appendChild(frag);

    // Wire edit/delete for the newly added cards
    servicesList.querySelectorAll('.edit-service-btn').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-id');
        const card = btn.closest('.card');
        const titleEl = card.querySelector('h3');
        const descEl = card.querySelector('p');
        const priceWrap = card.querySelector('p + p');

        const origTitle = titleEl.textContent;
        const origDesc = descEl.textContent;
        const priceMatch = (priceWrap.textContent.match(/[\d.,]+/) || ['0'])[0];

        titleEl.innerHTML = `<input type="text" class="edit-title input" value="${esc(origTitle)}">`;
        descEl.innerHTML = `<textarea class="edit-desc textarea">${esc(origDesc)}</textarea>`;
        priceWrap.innerHTML = `<strong>Price:</strong> $ <input type="number" class="edit-price input input-number" value="${esc(priceMatch)}">`;

        const btns = card.querySelector('.service-buttons');
        btns.innerHTML = `<button class="save-btn">Save</button> <button class="cancel-btn">Cancel</button>`;

        btns.querySelector('.save-btn').onclick = async () => {
          const updatedTitle = card.querySelector('.edit-title').value.trim();
          const updatedDesc = card.querySelector('.edit-desc').value.trim();
          const updatedPrice = card.querySelector('.edit-price').value.trim();
          if (!updatedTitle || !updatedDesc || !updatedPrice) { alert('All fields required'); return; }

          try {
            const res = await fetch(`${API_URL}/services/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
              body: JSON.stringify({ title: updatedTitle, description: updatedDesc, price: updatedPrice })
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || 'Failed to update');
            await loadServices({ reset: true });
          } catch (err) {
            console.error(err); alert('Failed to update service.');
          }
        };

        btns.querySelector('.cancel-btn').onclick = () => loadServices({ reset: true });
      };
    });

    servicesList.querySelectorAll('.delete-service-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this service?')) return;
        try {
          const res = await fetch(`${API_URL}/services/${id}`, {
            method: 'DELETE', headers: { Authorization: `Bearer ${token}` }
          });
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Failed to delete');
          await loadServices({ reset: true });
        } catch (err) {
          console.error(err); alert('Failed to delete.');
        }
      };
    });

    // Show/hide Load More
    if (svcHasMore) {
      loadMoreBtn.classList.remove('hidden');
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load more';
      svcPage += 1;
    } else {
      loadMoreBtn.classList.add('hidden');
    }
  } catch (err) {
    console.error(err);
    if (svcPage === 1) {
      servicesList.innerHTML = '<p>Failed to load services.</p>';
    }
  } finally {
    svcLoading = false;
  }
}

loadMoreBtn.addEventListener('click', () => loadServices({ reset: false }));

function toggleNewService() {
  newServiceSection.classList.toggle('show-flex');
}
document.getElementById('addNewServiceBtn').addEventListener('click', toggleNewService);
document.getElementById('mobileAddServiceBtn').addEventListener('click', toggleNewService);

createServiceBtn.addEventListener('click', async () => {
  const title = newServiceTitle.value.trim();
  const description = newServiceDesc.value.trim();
  const price = newServicePrice.value.trim();
  if (!title || !description || !price) return alert('All fields are required.');

  try {
    const res = await fetch(`${API_URL}/services`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ title, description, price })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || 'Failed to create');
    newServiceTitle.value = ''; newServiceDesc.value=''; newServicePrice.value='';
    newServiceSection.classList.remove('show-flex');
    await loadServices({ reset: true });
  } catch (err) {
    console.error(err); alert('Failed to create service.');
  }
});

// ------- Ratings
function renderStars(n) { return starText(n); }

async function loadRatings(userId) {
  ratingsList.innerHTML = '<p><span class="spinner"></span> Loading ratings...</p>';
  try {
    const res = await fetch(`${API_URL}/ratings/user/${userId}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

    const avg = data.summary?.average ?? 0;
    const count = data.summary?.count ?? 0;
    avgStarsEl.textContent = Number(avg).toFixed(1);
    ratingsCountEl.textContent = count;

    const ratings = data.ratings || [];
    if (!ratings.length) {
      ratingsList.innerHTML = '<p class="muted">No ratings yet.</p>';
      return;
    }

    ratingsList.innerHTML = ratings.map(r => `
      <div class="review">
        <div class="meta-row">
          <strong>${esc(r.rater?.username || ('User '+r.raterId))}</strong>
          <span class="stars">${renderStars(r.stars)}</span>
          <span class="badge">${Number(r.stars).toFixed(1)}</span>
          <span class="muted">${new Date(r.createdAt).toLocaleString()}</span>
        </div>
        ${r.comment ? `<p>${esc(r.comment)}</p>` : '<p class="muted">No comment</p>'}
      </div>
    `).join('');
  } catch (err) {
    console.error(err);
    ratingsList.innerHTML = '<p class="muted">Failed to load ratings.</p>';
  }
}

function initRateForm() {
  submitRatingBtn.addEventListener('click', async () => {
    rateMsg.textContent = '';
    const stars = parseInt(rateStars.value, 10);
    const comment = rateComment.value.trim();
    try {
      const res = await fetch(`${API_URL}/ratings`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ rateeId: profileUserId, stars, comment })
      });
      const data = await res.json();
      if (!res.ok) {
        if (res.status === 403) {
          rateMsg.textContent = data.error || 'Upgrade to a paid account to rate others.';
          rateUpgradeHint.classList.remove('hidden');
        } else {
          rateMsg.textContent = data.error || `HTTP ${res.status}`;
        }
        return;
      }
      rateMsg.textContent = data.message || 'Saved!';
      rateComment.value = '';
      await loadRatings(profileUserId);
    } catch (err) {
      console.error(err);
      rateMsg.textContent = 'Network error.';
    }
  });

  // Inline upgrade button (inside rate form when blocked)
  upgradeInlineBtn.addEventListener('click', doUpgrade);
}

// ------- Upgrade flow
async function doUpgrade() {
  try {
    const ok = confirm('Upgrade to a paid account?');
    if (!ok) return;
    const res = await fetch(`${API_URL}/users/me/upgrade`, {
      method: 'PUT',
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to upgrade');
    alert('Upgraded successfully!');
    currentUserTier = 'paid';
    await loadProfile(); // refresh UI (rate form appears)
  } catch (err) {
    alert(err.message || 'Upgrade failed');
  }
}

upgradeBtn.addEventListener('click', doUpgrade);

// ------- Nav + Logout
goToServicesBtn.addEventListener('click', () => window.location.href = 'services.html');
goToMessagesBtn.addEventListener('click', () => window.location.href = 'messages.html');
mobileServicesBtn.addEventListener('click', () => window.location.href = 'services.html');
mobileMessagesBtn.addEventListener('click', () => window.location.href = 'messages.html');

logoutBtn.addEventListener('click', () => {
  localStorage.clear();
  window.location.href = 'index.html';
});

// --- Back buttons
document.getElementById('backToMyProfileBtn').addEventListener('click', () => { window.location.href = 'profile.html'; });
mobileBackBtn.addEventListener('click', () => { window.location.href = 'profile.html'; });

// ------- Initial load
loadProfile().then(() => loadServices({ reset: true }));
loadRatings(profileUserId);
initRateForm();
</script>
</body>
</html>
