<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - CodeCrowds</title>
<link rel="stylesheet" href="profile.css" />
<script>window.API_URL = '/api';</script>
<script src="script.js"></script>
<script>
  // Guard: redirect unauthorized users to root (login screen)
  (function guard(){
    if (!isLoggedIn()) {
      const here = location.pathname + location.search;
      location.replace(`/?from=${encodeURIComponent(here)}`);
    }
  })();
</script>
<style>
  .hidden{display:none}
  .spinner{display:inline-block}
  .muted{color:#666}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06);margin-bottom:12px}
  .floating-btn{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 14px}
</style>
</head>
<body>
  <main class="container">
    <header>
      <h1 id="profile-username"><span class="spinner"></span> Loading username...</h1>
      <p id="profile-description"><span class="spinner"></span> Loading description...</p>
      <div id="descControls" class="hidden">
        <button type="button" id="editDescBtn">Edit Description</button>
      </div>
    </header>

    <section>
      <h2>User's Services</h2>
      <p class="section-subtle">These also appear on the Services page.</p>
      <div id="services-list"><p><span class="spinner"></span> Loading services...</p></div>

      <div class="row row-center row-gap-8 justify-center">
        <button type="button" id="loadMoreServicesBtn" class="hidden">Load more</button>
      </div>

      <div id="newServiceSection" class="new-service hidden">
        <input type="text" id="newServiceTitle" placeholder="Service Title" />
        <textarea id="newServiceDesc" placeholder="Service Description"></textarea>
        <input type="number" id="newServicePrice" placeholder="Price in USD" />
        <button type="button" id="createServiceBtn">Create Service</button>
      </div>
    </section>

    <section>
      <h2>Ratings & Reviews</h2>
      <div id="ratings-summary" class="card">
        <p><strong><span id="avg-stars">0.0</span> / 5.0</strong> • <span id="ratings-count">0</span> ratings</p>
      </div>

      <div id="rate-form" class="card hidden" aria-labelledby="rateFormTitle">
        <h3 id="rateFormTitle">Leave a rating</h3>
        <div class="row row-center row-gap-8">
          <label for="rateStars">Stars</label>
          <select id="rateStars" title="Select stars">
            <option value="5">5</option><option value="4">4</option>
            <option value="3">3</option><option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>
        <textarea id="rateComment" class="w-full" placeholder="Say something helpful (optional)" rows="3"></textarea>
        <button type="button" id="submitRatingBtn">Submit Rating</button>
        <p id="rateMsg" class="muted"></p>
        <div id="rateUpgradeHint" class="hidden muted">
          Rating is a paid feature.
          <button type="button" id="upgradeInlineBtn" class="upgrade-btn">Upgrade to Paid</button>
        </div>
      </div>

      <div id="ratings-list" class="review-list">
        <p><span class="spinner"></span> Loading ratings...</p>
      </div>
    </section>

    <div class="row row-center row-gap-8 justify-center">
      <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
      <button type="button" id="upgradeBtn" class="upgrade-btn hidden">Upgrade to Paid</button>
    </div>
  </main>

  <!-- Floating shortcuts (only on your own profile) -->
  <button type="button" class="floating-btn hidden" id="goToServicesBtn">Services</button>
  <button type="button" class="floating-btn hidden" id="goToMessagesBtn">Messages</button>
  <button type="button" class="floating-btn hidden" id="addNewServiceBtn">+ Service</button>
  <button type="button" class="floating-btn hidden" id="editDescBtnFloat">Edit Bio</button>
  <button type="button" class="floating-btn hidden" id="backToMyProfileBtn">← My Profile</button>

  <nav class="mobile-button-row hidden" id="mobileRow" aria-label="Mobile actions">
    <button type="button" id="mobileServicesBtn">Services</button>
    <button type="button" id="mobileMessagesBtn">Messages</button>
    <button type="button" id="mobileAddServiceBtn">+ Service</button>
    <button type="button" id="mobileBackBtn" class="hidden">My Profile</button>
  </nav>

<script>
const token = getToken();
const loggedInUserId = getUserId();
const API_URL = '/api';

const params = new URLSearchParams(location.search);
const qsUserId = params.get('userId');
const profileUserId = (qsUserId || loggedInUserId)?.toString();

const profileUsername = document.getElementById('profile-username');
const profileDescription = document.getElementById('profile-description');
const descControls = document.getElementById('descControls');
const editDescBtn = document.getElementById('editDescBtn');

const servicesList = document.getElementById('services-list');
const newServiceSection = document.getElementById('newServiceSection');
const newServiceTitle = document.getElementById('newServiceTitle');
const newServiceDesc = document.getElementById('newServiceDesc');
const newServicePrice = document.getElementById('newServicePrice');
const createServiceBtn = document.getElementById('createServiceBtn');

const goToServicesBtn = document.getElementById('goToServicesBtn');
const goToMessagesBtn = document.getElementById('goToMessagesBtn');
const addNewServiceBtn = document.getElementById('addNewServiceBtn');
const editDescBtnFloat = document.getElementById('editDescBtnFloat');
const mobileServicesBtn = document.getElementById('mobileServicesBtn');
const mobileMessagesBtn = document.getElementById('mobileMessagesBtn');
const mobileAddServiceBtn = document.getElementById('mobileAddServiceBtn');
const mobileRow = document.getElementById('mobileRow');
const mobileBackBtn = document.getElementById('mobileBackBtn');

const ratingsList = document.getElementById('ratings-list');
const avgStarsEl = document.getElementById('avg-stars');
const ratingsCountEl = document.getElementById('ratings-count');
const rateForm = document.getElementById('rate-form');
const rateStars = document.getElementById('rateStars');
const rateComment = document.getElementById('rateComment');
const submitRatingBtn = document.getElementById('submitRatingBtn');
const rateMsg = document.getElementById('rateMsg');
const rateUpgradeHint = document.getElementById('rateUpgradeHint');
const upgradeInlineBtn = document.getElementById('upgradeInlineBtn');

const logoutBtn = document.getElementById('logoutBtn');
const upgradeBtn = document.getElementById('upgradeBtn');
const backToMyProfileBtn = document.getElementById('backToMyProfileBtn');
const loadMoreBtn = document.getElementById('loadMoreServicesBtn');

let currentUserTier = 'free';
let svcPage = 1, svcLoading = false;

function showOwnerUI(isOwner){
  [goToServicesBtn,goToMessagesBtn,addNewServiceBtn,editDescBtnFloat,mobileRow,descControls,newServiceSection]
    .forEach(el=>el.classList.toggle('hidden',!isOwner));
  backToMyProfileBtn.classList.toggle('hidden',isOwner);
  mobileBackBtn.classList.toggle('hidden',isOwner);
}
const esc = (s)=>String(s??'').replace(/</g,'&lt;').replace(/>/g,'&gt;');

async function fetchMe(){
  const res = await fetch(`${API_URL}/users/me`, { headers:{Accept:'application/json',Authorization:`Bearer ${token}`}});
const raw = await res.json().catch(()=> ({}));
if (!res.ok) throw new Error(raw?.error?.message || raw?.error || `HTTP ${res.status}`);
const data = unwrap(raw);
currentUserTier = data.user?.tier || 'free';
return data.user;

}

async function loadProfile(){
  try{
    const viewingSelf = profileUserId === loggedInUserId;
    await fetchMe();
    const endpoint = viewingSelf ? `${API_URL}/users/me` : `${API_URL}/users/${profileUserId}`;
    const res = await fetch(endpoint, { headers:{Accept:'application/json',Authorization:`Bearer ${token}`}});
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    function getDisplayName(u) {
  // Try common keys; fallback to email prefix
  return (
    u.username ||
    u.name ||
    u.displayName ||
    (u.email ? u.email.split('@')[0] : '') ||
    ''
  );
}
function getDescription(u) {
  return u.description || u.bio || u.about || '';
}

// Optimistic render from localStorage (no flash of "User")
try {
  const cached = JSON.parse(localStorage.getItem('cc_me') || 'null');
  if (cached) {
    const dn = getDisplayName(cached);
    if (dn) profileUsername.textContent = dn;
    const desc = getDescription(cached);
    if (desc) profileDescription.textContent = desc;
  }
} catch {}

const u = data.user || data;
const displayName = getDisplayName(u) || 'Unknown User';
const desc = getDescription(u) || 'No description yet.';
profileUsername.textContent = displayName;
profileDescription.textContent = desc;

// keep cache fresh
try { localStorage.setItem('cc_me', JSON.stringify(u)); } catch {}

    showOwnerUI(viewingSelf);

    const canRate = (!viewingSelf && currentUserTier === 'paid');
    rateForm.classList.toggle('hidden', !canRate);
    rateUpgradeHint.classList.toggle('hidden', canRate);
    if (viewingSelf && currentUserTier === 'free') upgradeBtn.classList.remove('hidden'); else upgradeBtn.classList.add('hidden');
  }catch(err){
    console.error(err);
    profileUsername.textContent = 'Unknown User';
    profileDescription.textContent = 'Failed to load profile';
    showOwnerUI(false);
  }
}

let editingDesc=false;
function toggleDescEdit(force){
  editingDesc = typeof force==='boolean' ? force : !editingDesc;
  profileDescription.contentEditable = editingDesc;
  editDescBtn.textContent = editingDesc ? 'Save Description' : 'Edit Description';
  if (editingDesc) profileDescription.focus(); else profileDescription.blur();
}
async function saveDescription(){
  const newDesc = profileDescription.textContent.trim();
  try{
    const res = await fetch(`${API_URL}/users/me/description`, {
      method:'PUT', headers:{'Content-Type':'application/json',Accept:'application/json',Authorization:`Bearer ${token}`},
      body: JSON.stringify({ description:newDesc })
    });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(json.error || 'Failed to save description');
    profileDescription.textContent = json.user?.description || newDesc;
  }catch(err){ alert('Failed to save description'); console.error(err); }
  finally{ toggleDescEdit(false); }
}
editDescBtn.addEventListener('click', ()=> !editingDesc ? toggleDescEdit(true) : saveDescription());
document.getElementById('editDescBtnFloat').addEventListener('click', ()=> !editingDesc ? toggleDescEdit(true) : saveDescription());

function serviceCardHTML(s,isOwner){
  return `<div class="card">
    <h3>${esc(s.title)}</h3>
    <p>${esc(s.description)}</p>
    <p><strong>Price:</strong> $${Number(s.price).toLocaleString(undefined,{maximumFractionDigits:2})}</p>
    <div class="service-buttons ${isOwner ? '' : 'hidden'}">
      <button class="edit-service-btn" data-id="${s.id}">Edit</button>
      <button class="delete-service-btn" data-id="${s.id}">Delete</button>
    </div>
  </div>`;
}

async function loadServices({reset=false}={}){
  if (svcLoading) return; svcLoading = true;
  try{
    if (reset){ svcPage=1; servicesList.innerHTML='<p><span class="spinner"></span> Loading services...</p>'; loadMoreBtn.classList.add('hidden'); }
    const url = new URL(`${API_URL}/services`, location.origin);
    url.searchParams.set('userId', profileUserId);
    url.searchParams.set('limit','12');
    url.searchParams.set('page', String(svcPage));
    const res = await fetch(url, { headers:{Accept:'application/json',Authorization:`Bearer ${token}`}});
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    const list = data.services || [];
    const hasMore = !!data.hasMore;
    if (reset) servicesList.innerHTML='';
    if (!list.length && svcPage===1){
      servicesList.innerHTML = '<div class="card"><h3>No Services Yet</h3><p class="muted">Nothing posted yet.</p></div>';
      loadMoreBtn.classList.add('hidden'); return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(s=>{
      const isOwner = loggedInUserId === (s.user?.id?.toString() || s.userId?.toString() || '');
      const wrap = document.createElement('div'); wrap.innerHTML = serviceCardHTML(s,isOwner);
      frag.appendChild(wrap.firstElementChild);
    });
    servicesList.appendChild(frag);
    if (hasMore){ loadMoreBtn.classList.remove('hidden'); svcPage+=1; } else { loadMoreBtn.classList.add('hidden'); }
  }catch(err){
    console.error(err);
    if (svcPage===1) servicesList.innerHTML='<p>Failed to load services.</p>';
  }finally{ svcLoading=false; }
}
document.getElementById('loadMoreServicesBtn').addEventListener('click', ()=> loadServices({reset:false}));

function renderStars(n){ const r=Math.round(n); return '★'.repeat(r)+'☆'.repeat(5-r); }
async function loadRatings(userId){
  const ratingsList = document.getElementById('ratings-list');
  const avgStarsEl = document.getElementById('avg-stars');
  const ratingsCountEl = document.getElementById('ratings-count');

  ratingsList.innerHTML='<p><span class="spinner"></span> Loading ratings...</p>';
  try{
    const res = await fetch(`${API_URL}/ratings/user/${userId}`);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    const avg = data.summary?.average ?? 0, count = data.summary?.count ?? 0;
    avgStarsEl.textContent = Number(avg).toFixed(1);
    ratingsCountEl.textContent = count;
    const ratings = data.ratings || [];
    if (!ratings.length){ ratingsList.innerHTML = '<p class="muted">No ratings yet.</p>'; return; }
    ratingsList.innerHTML = ratings.map(r=>{
      return `<div class="review">
        <div class="meta-row">
          <strong>${esc(r.rater?.username || ('User '+r.raterId))}</strong>
          <span class="stars">${renderStars(r.stars)}</span>
          <span class="badge">${Number(r.stars).toFixed(1)}</span>
          <span class="muted">${new Date(r.createdAt).toLocaleString()}</span>
        </div>
        ${r.comment ? `<p>${esc(r.comment)}</p>` : '<p class="muted">No comment</p>'}
      </div>`;
    }).join('');
  }catch(err){
    console.error(err);
    ratingsList.innerHTML = '<p class="muted">Failed to load ratings.</p>';
  }
}
function initRateForm(){
  const rateForm = document.getElementById('rate-form');
  const rateUpgradeHint = document.getElementById('rateUpgradeHint');
  const upgradeInlineBtn = document.getElementById('upgradeInlineBtn');
  const rateStars = document.getElementById('rateStars');
  const rateComment = document.getElementById('rateComment');
  const submitRatingBtn = document.getElementById('submitRatingBtn');
  const rateMsg = document.getElementById('rateMsg');

  submitRatingBtn.addEventListener('click', async ()=>{
    rateMsg.textContent='';
    const stars = parseInt(rateStars.value,10);
    const comment = rateComment.value.trim();
    try{
      const res = await fetch(`${API_URL}/ratings`, {
        method:'POST',
        headers:{'Content-Type':'application/json',Accept:'application/json',Authorization:`Bearer ${token}`},
        body: JSON.stringify({ rateeId: profileUserId, stars, comment })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok){
        if (res.status===403){ rateMsg.textContent = data.error || 'Upgrade to a paid account to rate others.'; rateUpgradeHint.classList.remove('hidden'); }
        else { rateMsg.textContent = data.error || `HTTP ${res.status}`; }
        return;
      }
      rateMsg.textContent = data.message || 'Saved!';
      rateComment.value = '';
      await loadRatings(profileUserId);
    }catch(err){ console.error(err); rateMsg.textContent='Network error.'; }
  });
  upgradeInlineBtn.addEventListener('click', doUpgrade);
}
async function doUpgrade(){
  try{
    if (!confirm('Upgrade to a paid account?')) return;
    const res = await fetch(`${API_URL}/users/me/upgrade`, { method:'PUT', headers:{Accept:'application/json',Authorization:`Bearer ${token}`}});
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || 'Failed to upgrade');
    alert('Upgraded successfully!');
    currentUserTier='paid';
    await loadProfile();
  }catch(err){ alert(err.message || 'Upgrade failed'); }
}
document.getElementById('upgradeBtn').addEventListener('click', doUpgrade);

// nav + logout
document.getElementById('goToServicesBtn').addEventListener('click', ()=> location.href='services.html');
document.getElementById('goToMessagesBtn').addEventListener('click', ()=> location.href='messages.html');
document.getElementById('mobileServicesBtn').addEventListener('click', ()=> location.href='services.html');
document.getElementById('mobileMessagesBtn').addEventListener('click', ()=> location.href='messages.html');
document.getElementById('backToMyProfileBtn').addEventListener('click', ()=> { location.href='profile.html'; });
document.getElementById('mobileBackBtn').addEventListener('click', ()=> { location.href='profile.html'; });

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.clear();
  location.replace('/');
});

// init
loadProfile().then(()=> loadServices({reset:true}));
loadRatings(profileUserId);
initRateForm();
</script>
</body>
</html>
