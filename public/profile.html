<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - CodeCrowds</title>
<link rel="stylesheet" href="profile.css" />
<script>window.API_URL = '/api';</script>
<script src="script.js" defer></script>
<script defer>
  // Guard: redirect unauthorized users to root (login)
  (function guard(){
    if (!isLoggedIn()) {
      const here = location.pathname + location.search;
      location.replace(`/?from=${encodeURIComponent(here)}`);
    }
  })();
</script>
<style>
  .hidden{display:none}
  .spinner{display:inline-block}
  .muted{color:#666}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06);margin-bottom:12px}
  .floating-btn{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 14px}
</style>
</head>
<body>
  <main class="container">
    <header>
      <h1 id="profile-username"><span class="spinner"></span> Loading username...</h1>
      <p id="profile-description"><span class="spinner"></span> Loading description...</p>
      <div id="descControls" class="hidden">
        <button type="button" id="editDescBtn">Edit Description</button>
      </div>
    </header>

    <section>
      <h2>User's Services</h2>
      <p class="section-subtle">These also appear on the Services page.</p>
      <div id="services-list"><p><span class="spinner"></span> Loading services...</p></div>

      <div class="row row-center row-gap-8 justify-center">
        <button type="button" id="loadMoreServicesBtn" class="hidden">Load more</button>
      </div>

      <!-- stays hidden until + Service is clicked -->
      <div id="newServiceSection" class="new-service hidden">
        <input type="text" id="newServiceTitle" placeholder="Service Title" />
        <textarea id="newServiceDesc" placeholder="Service Description"></textarea>
        <input type="number" id="newServicePrice" placeholder="Price in USD" />
        <button type="button" id="createServiceBtn">Create Service</button>
      </div>
    </section>

    <section>
      <h2>Ratings & Reviews</h2>
      <div id="ratings-summary" class="card">
        <p><strong><span id="avg-stars">0.0</span> / 5.0</strong> • <span id="ratings-count">0</span> ratings</p>
      </div>

      <div id="rate-form" class="card hidden" aria-labelledby="rateFormTitle">
        <h3 id="rateFormTitle">Leave a rating</h3>
        <div class="row row-center row-gap-8">
          <label for="rateStars">Stars</label>
          <select id="rateStars" title="Select stars">
            <option value="5">5</option><option value="4">4</option>
            <option value="3">3</option><option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>
        <textarea id="rateComment" class="w-full" placeholder="Say something helpful (optional)" rows="3"></textarea>
        <button type="button" id="submitRatingBtn">Submit Rating</button>
        <p id="rateMsg" class="muted"></p>
        <div id="rateUpgradeHint" class="hidden muted">
          Rating is a paid feature.
          <button type="button" id="upgradeInlineBtn" class="upgrade-btn">Upgrade to Paid</button>
        </div>
      </div>

      <div id="ratings-list" class="review-list">
        <p><span class="spinner"></span> Loading ratings...</p>
      </div>
    </section>

    <div class="row row-center row-gap-8 justify-center">
      <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
      <button type="button" id="upgradeBtn" class="upgrade-btn hidden">Upgrade to Paid</button>
    </div>
  </main>

  <!-- Floating shortcuts (only on your own profile) -->
  <button type="button" class="floating-btn hidden" id="goToServicesBtn">Services</button>
  <button type="button" class="floating-btn hidden" id="goToMessagesBtn">Messages</button>
  <button type="button" class="floating-btn hidden" id="addNewServiceBtn">+ Service</button>
  <button type="button" class="floating-btn hidden" id="editDescBtnFloat">Edit Bio</button>

  <!-- Back to my profile (visible only when viewing someone else) -->
  <button type="button" class="floating-btn hidden" id="backToMyProfileBtn">← My Profile</button>

  <nav class="mobile-button-row hidden" id="mobileRow" aria-label="Mobile actions">
    <button type="button" id="mobileServicesBtn">Services</button>
    <button type="button" id="mobileMessagesBtn">Messages</button>
    <button type="button" id="mobileAddServiceBtn">+ Service</button>
    <button type="button" id="mobileBackBtn" class="hidden">My Profile</button>
  </nav>

<script defer>
// ===== pull helpers from script.js
const API_URL = '/api';
const token = getToken();

// 1) Read cached user immediately to avoid "Unknown User" flash
try {
  const cached = JSON.parse(localStorage.getItem('cc_me') || 'null');
  if (cached) {
    const cachedName = getDisplayName(cached);
    if (cachedName) document.getElementById('profile-username').textContent = cachedName;
    const cachedDesc = getDescription(cached);
    if (cachedDesc) document.getElementById('profile-description').textContent = cachedDesc;

    // Perceived speed: if not viewing ?userId, it's self—show owner controls instantly
    const params = new URLSearchParams(location.search);
    if (cached.id && !params.get('userId')) showOwnerUI(true);
  }
} catch {}

// ---- DOM
const profileUsername = document.getElementById('profile-username');
const profileDescription = document.getElementById('profile-description');
const descControls = document.getElementById('descControls');
const editDescBtn = document.getElementById('editDescBtn');

const servicesList = document.getElementById('services-list');
const newServiceSection = document.getElementById('newServiceSection');
const newServiceTitle = document.getElementById('newServiceTitle');
const newServiceDesc = document.getElementById('newServiceDesc');
const newServicePrice = document.getElementById('newServicePrice');
const createServiceBtn = document.getElementById('createServiceBtn');

const goToServicesBtn = document.getElementById('goToServicesBtn');
const goToMessagesBtn = document.getElementById('goToMessagesBtn');
const addNewServiceBtn = document.getElementById('addNewServiceBtn');
const editDescBtnFloat = document.getElementById('editDescBtnFloat');
const mobileServicesBtn = document.getElementById('mobileServicesBtn');
const mobileMessagesBtn = document.getElementById('mobileMessagesBtn');
const mobileAddServiceBtn = document.getElementById('mobileAddServiceBtn');
const mobileRow = document.getElementById('mobileRow');
const mobileBackBtn = document.getElementById('mobileBackBtn');

const ratingsList = document.getElementById('ratings-list');
const avgStarsEl = document.getElementById('avg-stars');
const ratingsCountEl = document.getElementById('ratings-count');
const rateForm = document.getElementById('rate-form');
const rateStars = document.getElementById('rateStars');
const rateComment = document.getElementById('rateComment');
const submitRatingBtn = document.getElementById('submitRatingBtn');
const rateMsg = document.getElementById('rateMsg');
const rateUpgradeHint = document.getElementById('rateUpgradeHint');
const upgradeInlineBtn = document.getElementById('upgradeInlineBtn');

const logoutBtn = document.getElementById('logoutBtn');
const upgradeBtn = document.getElementById('upgradeBtn');
const backToMyProfileBtn = document.getElementById('backToMyProfileBtn');
const loadMoreBtn = document.getElementById('loadMoreServicesBtn');

let currentUserTier = 'free';
let svcPage = 1, svcLoading = false;
let svcAborter = null;

function esc(s){ return String(s ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Only toggle owner UI controls (not the newServiceSection; that opens on click)
function showOwnerUI(isOwner){
  [goToServicesBtn,goToMessagesBtn,addNewServiceBtn,editDescBtnFloat,mobileRow,descControls]
    .forEach(el=>el.classList.toggle('hidden',!isOwner));
  backToMyProfileBtn.classList.toggle('hidden',isOwner);
  mobileBackBtn.classList.toggle('hidden',isOwner);

  // Keep the form hidden by default; the +Service button will reveal it.
  if (!isOwner) {
    newServiceSection.classList.add('hidden');
    newServiceSection.classList.remove('show-flex');
  }
}

// 2) Fetch /users/me (unwrapped), set userId if missing, and render
async function fetchMe() {
  const me = await apiFetch('users/me'); // -> { user }
  const u = me?.user || {};

  // Ensure userId is stored so owner UI shows:
  if (!getUserId() && u.id) setUserId(String(u.id));

  // Cache full user + name
  try {
    localStorage.setItem('cc_me', JSON.stringify(u));
    const dn = getDisplayName(u);
    if (dn) localStorage.setItem('username', dn);
  } catch {}

  currentUserTier = u.tier || 'free';
  return u;
}

async function loadProfile() {
  try {
    const me = await fetchMe();
    const loggedInUserId = getUserId();

    // Profile target: if ?userId present, viewing someone else; otherwise self
    const params = new URLSearchParams(location.search);
    const qsUserId = params.get('userId');
    const profileUserId = (qsUserId || loggedInUserId)?.toString();

    // Fetch profile (self or public)
    const data = qsUserId ? await apiFetch(`users/${profileUserId}`) : { user: me };
    const u = data.user || data;

    // Render name + description with fallbacks
    profileUsername.textContent = getDisplayName(u) || 'User';
    profileDescription.textContent = getDescription(u) || 'No description yet.';

    // Owner UI (controls + floating buttons)
    const viewingSelf = profileUserId === loggedInUserId;
    showOwnerUI(viewingSelf);

    // Rating visibility
    const canRate = (!viewingSelf && currentUserTier === 'paid');
    rateForm.classList.toggle('hidden', !canRate);
    rateUpgradeHint.classList.toggle('hidden', canRate);

    if (viewingSelf && currentUserTier === 'free') {
      upgradeBtn.classList.remove('hidden');
    } else {
      upgradeBtn.classList.add('hidden');
    }

    // Load lists (faster perceived load: services first; ratings lazily)
    await loadServices({ reset: true, userId: profileUserId });
    const lazy = (cb)=> (window.requestIdleCallback ? requestIdleCallback(cb, { timeout: 1500 }) : setTimeout(cb, 0));
    lazy(()=> loadRatings(profileUserId));

  } catch (err) {
    console.error('Profile load error:', err);
    profileUsername.textContent = 'User';
    profileDescription.textContent = 'Failed to load profile';
    showOwnerUI(false);
  }
}

// Services list (simple paging)
function serviceCardHTML(s,isOwner){
  return `<div class="card">
    <h3>${esc(s.title)}</h3>
    <p>${esc(s.description)}</p>
    <p><strong>Price:</strong> $${Number(s.price).toLocaleString(undefined,{maximumFractionDigits:2})}</p>
    <div class="service-buttons ${isOwner ? '' : 'hidden'}">
      <button class="edit-service-btn" data-id="${s.id}">Edit</button>
      <button class="delete-service-btn" data-id="${s.id}">Delete</button>
    </div>
  </div>`;
}

async function loadServices({reset=false, userId} = {}) {
  if (svcLoading) return; svcLoading = true;
  try{
    const loggedInUserId = getUserId();

    if (reset){
      svcPage=1;
      // lightweight skeletons for instant paint
      servicesList.innerHTML = Array.from({length:3}).map(()=>`
        <div class="card fade-in">
          <h3 style="background:#eee;height:18px;width:60%;border-radius:6px;"></h3>
          <p style="background:#f2f2f2;height:14px;width:100%;border-radius:6px;"></p>
          <p style="background:#f2f2f2;height:14px;width:80%;border-radius:6px;"></p>
        </div>
      `).join('');
      loadMoreBtn.classList.add('hidden');
    }

    const url = new URL(`${API_URL}/services`, location.origin);
    if (userId) url.searchParams.set('userId', userId);
    url.searchParams.set('limit', svcPage === 1 ? '6' : '12'); // smaller first page for speed
    url.searchParams.set('page', String(svcPage));

    if (svcAborter) { try { svcAborter.abort(); } catch {} }
    svcAborter = new AbortController();

    const data = await apiFetch(url.pathname + url.search, { signal: svcAborter.signal }); // "signal" should be forwarded by apiFetch
    const list = data.services || [];
    const hasMore = !!data.hasMore;

    if (reset) servicesList.innerHTML='';
    if (!list.length && svcPage===1){
      servicesList.innerHTML = '<div class="card"><h3>No Services Yet</h3><p class="muted">Nothing posted yet.</p></div>';
      loadMoreBtn.classList.add('hidden'); return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(s=>{
      const isOwner = loggedInUserId === (s.user?.id?.toString() || s.userId?.toString() || '');
      const wrap = document.createElement('div'); wrap.innerHTML = serviceCardHTML(s,isOwner);
      frag.appendChild(wrap.firstElementChild);
    });
    servicesList.appendChild(frag);

    if (hasMore){ loadMoreBtn.classList.remove('hidden'); svcPage+=1; } else { loadMoreBtn.classList.add('hidden'); }
  }catch(err){
    if (err?.name !== 'AbortError') {
      console.error(err);
      if (svcPage===1) servicesList.innerHTML='<p>Failed to load services.</p>';
    }
  }finally{ svcLoading=false; }
}
loadMoreBtn.addEventListener('click', ()=> loadServices({ reset:false }));

// Ratings
function renderStars(n){ const r=Math.round(n); return '★'.repeat(r)+'☆'.repeat(5-r); }
async function loadRatings(userId){
  ratingsList.innerHTML='<p><span class="spinner"></span> Loading ratings...</p>';
  try{
    const data = await apiFetch(`ratings/user/${userId}`); // unwrapped
    const avg = data.summary?.average ?? 0, count = data.summary?.count ?? 0;
    avgStarsEl.textContent = Number(avg).toFixed(1);
    ratingsCountEl.textContent = count;
    const ratings = data.ratings || [];
    if (!ratings.length){ ratingsList.innerHTML = '<p class="muted">No ratings yet.</p>'; return; }
    ratingsList.innerHTML = ratings.map(r=>{
      return `<div class="review">
        <div class="meta-row">
          <strong>${esc(r.rater?.username || ('User '+r.raterId))}</strong>
          <span class="stars">${renderStars(r.stars)}</span>
          <span class="badge">${Number(r.stars).toFixed(1)}</span>
          <span class="muted">${new Date(r.createdAt).toLocaleString()}</span>
        </div>
        ${r.comment ? `<p>${esc(r.comment)}</p>` : '<p class="muted">No comment</p>'}
      </div>`;
    }).join('');
  }catch(err){
    console.error(err);
    ratingsList.innerHTML = '<p class="muted">Failed to load ratings.</p>';
  }
}

// Edit / Save description
let editingDesc=false;
function toggleDescEdit(force){
  editingDesc = typeof force==='boolean' ? force : !editingDesc;
  profileDescription.contentEditable = editingDesc;
  editDescBtn.textContent = editingDesc ? 'Save Description' : 'Edit Description';
  if (editingDesc) profileDescription.focus(); else profileDescription.blur();
}
async function saveDescription(){
  const newDesc = profileDescription.textContent.trim();
  try{
    const out = await apiFetch('users/me/description', {
      method:'PUT',
      body: { description: newDesc }
    });
    const saved = out?.user || {};
    profileDescription.textContent = getDescription(saved) || newDesc;
  }catch(err){ alert('Failed to save description'); console.error(err); }
  finally{ toggleDescEdit(false); }
}
editDescBtn.addEventListener('click', ()=> !editingDesc ? toggleDescEdit(true) : saveDescription());
document.getElementById('editDescBtnFloat').addEventListener('click', ()=> !editingDesc ? toggleDescEdit(true) : saveDescription());

// nav + logout + upgrade
document.getElementById('goToServicesBtn').addEventListener('click', ()=> location.href='services.html');
document.getElementById('goToMessagesBtn').addEventListener('click', ()=> location.href='messages.html');
document.getElementById('mobileServicesBtn').addEventListener('click', ()=> location.href='services.html');
document.getElementById('mobileMessagesBtn').addEventListener('click', ()=> location.href='messages.html');

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.clear();
  location.replace('/');
});
document.getElementById('upgradeBtn').addEventListener('click', async ()=>{
  try{
    if (!confirm('Upgrade to a paid account?')) return;
    await apiFetch('users/me/upgrade', { method:'PUT' });
    alert('Upgraded successfully!');
    currentUserTier = 'paid';
    await loadProfile();
  }catch(err){ alert(err.message || 'Upgrade failed'); }
});

/* ===== + Service button behavior ===== */
function openNewService() {
  // ensure visible & flex layout
  newServiceSection.classList.remove('hidden');
  newServiceSection.classList.add('show-flex');
  newServiceTitle.focus();
  try { newServiceSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {}
}
addNewServiceBtn.addEventListener('click', openNewService);
mobileAddServiceBtn.addEventListener('click', openNewService);

/* ===== Create Service handler ===== */
async function createService() {
  const title = newServiceTitle.value.trim();
  const description = newServiceDesc.value.trim();
  const price = Number(newServicePrice.value);

  if (!title) { alert('Title is required'); return; }
  if (Number.isNaN(price) || price < 0) { alert('Enter a valid price'); return; }

  try {
    await apiFetch('services', {
      method: 'POST',
      body: { title, description, price }
    });

    // Clear form
    newServiceTitle.value = '';
    newServiceDesc.value = '';
    newServicePrice.value = '';

    // Refresh list for the current user
    await loadServices({ reset: true, userId: getUserId() });
  } catch (err) {
    console.error(err);
    alert('Failed to create service');
  }
}
createServiceBtn.addEventListener('click', createService);

// init
loadProfile();
</script>
</body>
</html>
